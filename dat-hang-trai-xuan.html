<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Đặt món hội trại</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f4f4; }
    nav { background: #222; padding: 10px; display: flex; justify-content: space-around; position: sticky; top: 0; }
    nav button { background: none; border: none; color: #fff; font-size: 14px; }
    .container { padding: 12px; }
    .card { background: #fff; padding: 14px; border-radius: 10px; margin-bottom: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
    h2 { margin: 0 0 10px; font-size: 18px; }
    label { display: block; margin-top: 8px; font-weight: 600; font-size: 14px; }
    select, input { width: 100%; padding: 10px; margin-top: 4px; font-size: 14px; border-radius: 6px; border: 1px solid #ccc; }
    button { width: 100%; padding: 12px; margin-top: 12px; font-size: 15px; border: none; border-radius: 8px; background: #ff5722; color: #fff; }
    button.secondary { background: #555; }
    .hidden { display: none; }
    .qty { display:flex; align-items:center; gap:10px; margin-top:6px; justify-content:center; }
    .qty button { width: 36px; height: 36px; border-radius: 50%; padding: 0; }
    .qty input { width: 60px; text-align: center; }
    table { width:100%; border-collapse:collapse; margin-top:10px; font-size:13px; }
    th, td { border-bottom:1px solid #ddd; padding:6px; text-align:left; }
    th { background:#fafafa; }
    button {
  transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.1s ease;
}

button:active {
  transform: scale(0.96);
  box-shadow: 0 2px 6px rgba(0,0,0,0.15) inset;
  opacity: 0.9;
}

  </style>
</head>
<body>

<nav>
  <button type="button" onclick="showSection('single')">Món lẻ</button>
  <button type="button" onclick="showSection('combo')">Combo</button>
  <button type="button" onclick="showSection('cart')">Giỏ hàng</button>
</nav>

<div class="container">

<div class="card" id="customerCard">
  <h2>Thông tin nhận hàng</h2>
  <label>Tên khách *</label>
  <input id="customerName" />

  <label>Lớp / địa chỉ lớp *</label>
  <input id="classAddress" />

  <label>Link facebook *</label>
  <input id="campName" />

  <label>Khung giờ nhận *</label>
  <select id="pickupTime">
    <option value="">-- Chọn --</option>
    <option>8:00 – 9:00</option>
    <option>9:00 – 10:00</option>
    <option>10:00 – 11:00</option>
    <option>13:00 – 14:00</option>
    <option>14:00 – 15:00</option>
  </select>

  <button class="secondary" onclick="saveCustomer()">Lưu thông tin</button>
</div>

<div id="single" class="card">
  <h2>Món lẻ</h2>
  <label>Món</label>
  <select id="singleItem" onchange="toggleDrinkOptions(this.value)">
    <option value="" disabled selected>Vui lòng chọn món</option>
    <option>Gà</option>
    <option>Pudding trứng</option>
    <option>Pudding hồng trà</option>
    <option>Tàu hũ Singapore</option>
    <option>Trà chanh dây</option>
  </select>

  <div id="drinkOptions" class="hidden">
    <label>Đá (cho đồ uống)</label>
    <select id="singleIce"><option>Đá bình thường</option><option>Ít đá</option><option>Không đá</option></select>
    <label>Thạch (cho đồ uống)</label>
    <select id="singleJelly"><option>Thạch bình thường</option><option>Không thạch</option></select>
  </div>

  <label>Số lượng</label>
  <div class="qty">
    <button onclick="changeQty('singleQty',-1)">-</button>
    <input id="singleQty" type="number" value="1" min="1" />
    <button onclick="changeQty('singleQty',1)">+</button>
  </div>

  <button onclick="addSingleToCart()">Thêm vào giỏ</button>
</div>

<div id="combo" class="card hidden">
  <h2>Combo</h2>
  <label>Chọn combo</label>
  <select id="comboType" onchange="renderComboOptions()">
    <option value="" disabled selected> Vui lòng chọn combo </option>
    <option>Combo 1</option>
    <option>Combo 2</option>
    <option>Combo 3</option>
  </select>

  <div id="comboOptions"></div>

  <label>Số lượng</label>
  <div class="qty">
    <button onclick="changeQty('comboQty',-1)">-</button>
    <input id="comboQty" type="number" value="1" min="1" />
    <button onclick="changeQty('comboQty',1)">+</button>
  </div>

  <button onclick="addComboToCart()">Thêm vào giỏ</button>
</div>

<div id="cart" class="card hidden">
  <h2>Giỏ hàng</h2>
  <table>
    <thead><tr><th>Loại</th><th>Món</th><th>SL</th><th></th></tr></thead>
    <tbody id="cartTable"></tbody>
  </table>
  <button onclick="submitCart()">Xác nhận đặt món</button>
</div>

</div>

<script>
const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxqbfyylKyqytrKI9Bg_6x0cjMVXTjwwbY4NWWTjxnoRtLwsn_ZuJWWC7CqoUWmNnqHaw/exec';
let cart = [];
let editingComboIndex = null;


window.onload = () => {
  const c = JSON.parse(localStorage.getItem('customer'));
  if(c){
    customerName.value=c.ten;
    classAddress.value=c.lop;
    campName.value=c.trai;
    pickupTime.value=c.gio;
  }
};
function editCombo(index){
  const item = cart[index];

  if(item.loai !== 'Combo') return;

  // Lưu index đang sửa
  editingComboIndex = index;

  // Chuyển sang tab combo
  showSection('combo');

  // Set combo
  comboType.value = item.noiDung;
  renderComboOptions();

  // Set số lượng
  comboQty.value = item.soLuong;

  // Set chi tiết
  setTimeout(() => {
    if(item.chiTiet.trangmieng){
      const dessertEl = document.getElementById('comboDessert');
      if(dessertEl){
        if(Array.isArray(item.chiTiet.trangmieng)){
          dessertEl.value = item.chiTiet.trangmieng[0];
        } else {
          dessertEl.value = item.chiTiet.trangmieng;
        }
      }
    }

    if(item.chiTiet.da){
      const iceEl = document.getElementById('comboIce');
      if(iceEl) iceEl.value = item.chiTiet.da;
    }

    if(item.chiTiet.thach){
      const jellyEl = document.getElementById('comboJelly');
      if(jellyEl) jellyEl.value = item.chiTiet.thach;
    }
  }, 50);

  // Xóa combo cũ khỏi giỏ
  cart.splice(index, 1);
}

function saveCustomer(){
  if(!customerName.value||!classAddress.value||!campName.value||!pickupTime.value){
    alert('Vui lòng nhập đủ thông tin');
    return;
  }
  localStorage.setItem('customer',JSON.stringify({
    ten:customerName.value,
    lop:classAddress.value,
    trai:campName.value,
    gio:pickupTime.value
  }));
  alert('Đã lưu thông tin');
}

function showSection(id){
  ['single','combo','cart'].forEach(s=>document.getElementById(s).classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  if(id==='cart') renderCart();
}

function toggleDrinkOptions(v){
  drinkOptions.classList.toggle('hidden',v!=='Trà chanh dây');
}

function changeQty(id,d){
  const i=document.getElementById(id);
  i.value=Math.max(1,parseInt(i.value||1)+d);
}

function renderComboOptions(){
  comboOptions.innerHTML='';

  // Đồ uống
  if(['Combo 1','Combo 3'].includes(comboType.value)){
    comboOptions.innerHTML+=`
      <label>Đá (cho đồ uống)</label>
      <select id="comboIce">
        <option selected>Đá bình thường</option>
        <option>Ít đá</option>
        <option>Không đá</option>
      </select>

      <label>Thạch (cho đồ uống)</label>
      <select id="comboJelly">
        <option selected>Thạch bình thường</option>
        <option>Không thạch</option>
      </select>
    `;
  }

  // Combo 1: 1 tráng miệng
  if(comboType.value === 'Combo 1'){
    comboOptions.innerHTML+=`
      <label>Tráng miệng</label>
      <select id="comboDessert1">
        <option>Pudding trứng</option>
        <option>Pudding hồng trà</option>
        <option>Tàu hũ Singapore</option>
      </select>
    `;
  }

  // Combo 2: 2 tráng miệng (KHÔNG TRÙNG)
  if(comboType.value === 'Combo 2'){
    comboOptions.innerHTML+=`
      <label>Tráng miệng 1</label>
      <select id="comboDessert1">
        <option>Pudding trứng</option>
        <option>Pudding hồng trà</option>
        <option>Tàu hũ Singapore</option>
      </select>

      <label>Tráng miệng 2</label>
      <select id="comboDessert2">
        <option>Pudding trứng</option>
        <option>Pudding hồng trà</option>
        <option>Tàu hũ Singapore</option>
      </select>
    `;
  }
}


function addSingleToCart(){
  cart.push({
    loai:'Món lẻ',
    noiDung: singleItem.value + (singleItem.value==='Trà chanh dây'
      ? ` (${singleIce.value}, ${singleJelly.value})`
      : ''),
    soLuong: singleQty.value
  });
  alert('Đã thêm');
}
function addComboToCart(){
  const iceEl = document.getElementById('comboIce');
  const jellyEl = document.getElementById('comboJelly');
  const dessertEl = document.getElementById('comboDessert');

  const newItem = {
    loai:'Combo',
    noiDung: comboType.value,
    chiTiet:{
      trangmieng: dessertEl ? dessertEl.value : '',
      da: iceEl ? iceEl.value : 'Đá bình thường',
      thach: jellyEl ? jellyEl.value : 'Thạch bình thường'
    },
    soLuong: comboQty.value
  };

  cart.push(newItem);

  editingComboIndex = null;

  alert('Đã cập nhật combo');
}

function formatComboDetail(chiTiet){
  let result = '';

  if(chiTiet.trangmieng){
    result += `Tráng miệng: ${chiTiet.trangmieng}`;
  }

  if(chiTiet.da || chiTiet.thach){
    result += `<br>Nước: ${chiTiet.da || ''}${chiTiet.thach ? ', ' + chiTiet.thach : ''}`;
  }

  return result;
}


function renderCart(){
  cartTable.innerHTML = '';

  cart.forEach((c, i) => {
    let displayName = c.noiDung;

    if(c.loai === 'Combo' && c.chiTiet){
      displayName += `<br><small style="color:#555">
        ${formatComboDetail(c.chiTiet)}
      </small>`;
    }

    cartTable.innerHTML += `
      <tr>
        <td>${c.loai}</td>
        <td>${displayName}</td>
        <td>${c.soLuong}</td>
        <td>
          ${c.loai === 'Combo'
            ? `<button onclick="editCombo(${i})">Sửa combo</button>`
            : ''
          }
          <button onclick="cart.splice(${i},1);renderCart()">Xóa</button>
        </td>
      </tr>
    `;
  });
}


  fetch(SHEET_URL,{
    method:'POST',
    mode:'no-cors',
    body: JSON.stringify({customer, cart})
  })
  .then(()=>{
    // ✅ Xóa thông tin sau khi đặt xong
    localStorage.removeItem('customer');
    cart = [];

    window.location.href = 'thankyou.html';
  })
  .catch(err=>{
    console.error('Fetch error:', err);
    alert('Không gửi được đơn hàng. Vui lòng kiểm tra kết nối mạng.');
  });
}


// Basic runtime tests
console.assert(typeof renderComboOptions === 'function','renderComboOptions should exist');
console.assert(typeof addComboToCart === 'function','addComboToCart should exist');
console.assert(typeof submitCart === 'function','submitCart should exist');
</script>
</body>
</html>










